<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Severn_06: Modelling a regulated diversion • airGRiwrm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Severn_06: Modelling a regulated diversion">
<meta property="og:description" content="airGRiwrm">
<meta property="og:image" content="https://airgriwrm.g-eau.fr/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">airGRiwrm</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.6.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/airGRiwrm.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">Quick start on the Severn River (UK)</li>
    <li>
      <a href="../articles/V01_Structure_SD_model.html">Severn_01: Set up of a semi-distributed GR model network</a>
    </li>
    <li>
      <a href="../articles/V02_Calibration_SD_model.html">Severn_02: Calibration of a GR4J semi-distributed model network</a>
    </li>
    <li>
      <a href="../articles/V03_Open-loop_influenced_flow.html">Severn_03: Calibration of an open-loop influenced flow model network</a>
    </li>
    <li>
      <a href="../articles/V04_Closed-loop_regulated_withdrawal.html">Severn_04: Modelling a regulated withdrawal (closed-loop control)</a>
    </li>
    <li>
      <a href="../articles/V05_Modelling_ungauged_nodes.html">Severn_05: Modelling ungauged stations</a>
    </li>
    <li>
      <a href="../articles/V06_Modelling_regulated_diversion.html">Severn_06: Modelling a regulated diversion</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Example of a large network on the Seine River (France)</li>
    <li>
      <a href="../articles/seinebasin/V01_First_network.html">Seine_01: Structuration of a semi-distributed GR4J model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V02_First_run.html">Seine_02: Run a semi-distributed GR model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V03_First_Calibration.html">Seine_03: Calibration of a semi-distributed GR model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V04_Open-loop_influenced_flow.html">Seine_04: Running open-loop influenced flow semi-distributed model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V05_Open-loop_influenced_flow_calibration.html">Seine_05: Calibration of an open-loop influenced flow semi-distributed model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V05b_Open-loop_influenced_flow_calibration_GR6J.html">Seine_05b: Calibration of an open-loop influenced flow semi-distributed GR6J model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V06_Naturalised_flow_simulation.html">Seine_06: Simulate naturalized flows with a model network calibrated with influenced flows</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    airGR Galaxy
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://hydrogr.github.io/airGR/" class="external-link">airGR</a>
    </li>
    <li>
      <a href="https://CRAN.R-project.org/package=airGRdatassim" class="external-link">airGRdatassim R-package</a>
    </li>
    <li>
      <a href="https://sunshine.irstea.fr/app/airGRmaps" class="external-link">airGRmaps web app</a>
    </li>
    <li>
      <a href="https://hydroGR.github.io/airGRteaching/" class="external-link">airGRteaching R-package</a>
    </li>
    <li>
      <a href="https://sunshine.irstea.fr/app/airGRteaching" class="external-link">airGRteaching web app</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/inrae/airGRiwrm" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://gitlab.irstea.fr/in-wop/airGRiwrm" class="external-link">
    <span class="fab fa-gitlab fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Severn_06: Modelling a regulated diversion</h1>
            
      
      <small class="dont-index">Source: <a href="https://gitlab.irstea.fr/in-wop/airGRiwrm/-/blob/master/vignettes/V06_Modelling_regulated_diversion.Rmd" class="external-link"><code>vignettes/V06_Modelling_regulated_diversion.Rmd</code></a></small>
      <div class="hidden name"><code>V06_Modelling_regulated_diversion.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inrae.github.io/airGRiwrm/" class="external-link">airGRiwrm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: airGR</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'airGRiwrm'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:airGR':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Calibration, CreateCalibOptions, CreateInputsCrit,</span></span>
<span><span class="co">#&gt;     CreateInputsModel, CreateRunOptions, RunModel</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Severn</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="the-study-case">The study case<a class="anchor" aria-label="anchor" href="#the-study-case"></a>
</h2>
<p>In this vignette, we are still using the study case of the vignette
#1 and #2, and we are going to simulate a diversion at the node “54001”
to provide flow to the node “54029” in order to support low flows in the
Severn river.</p>
<p>This objective is to maintain a minimum flow equals to the 3th decile
of the flow at station “54029” without remaining less than the first
decile of the flow downstream the station “54001”.</p>
<p>Let’s compute the flow quantiles at each station in m3/s:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">Severn</span><span class="op">$</span><span class="va">BasinsObs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">$</span><span class="va">discharge_spec</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Qobs</span> <span class="op">&lt;-</span> <span class="va">Qobs</span><span class="op">[</span>, <span class="va">Severn</span><span class="op">$</span><span class="va">BasinsInfo</span><span class="op">$</span><span class="va">gauge_id</span><span class="op">]</span></span>
<span><span class="va">Qobs_m3s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Qobs</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="va">r</span> <span class="op">*</span> <span class="va">Severn</span><span class="op">$</span><span class="va">BasinsInfo</span><span class="op">$</span><span class="va">area</span> <span class="op">*</span> <span class="fl">1E3</span> <span class="op">/</span> <span class="fl">86400</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Qobs_m3s</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"54029"</span>, <span class="st">"54001"</span><span class="op">)</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.1</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;           54029      54001</span></span>
<span><span class="co">#&gt; 0%     1.030312   7.517187</span></span>
<span><span class="co">#&gt; 10%    2.575781  11.526354</span></span>
<span><span class="co">#&gt; 20%    3.949531  15.034375</span></span>
<span><span class="co">#&gt; 30%    5.323281  20.045833</span></span>
<span><span class="co">#&gt; 40%    7.383906  26.059583</span></span>
<span><span class="co">#&gt; 50%    9.787969  34.077917</span></span>
<span><span class="co">#&gt; 60%   13.050625  44.601979</span></span>
<span><span class="co">#&gt; 70%   18.717344  62.142083</span></span>
<span><span class="co">#&gt; 80%   27.475000  90.707396</span></span>
<span><span class="co">#&gt; 90%   42.586250 143.828854</span></span>
<span><span class="co">#&gt; 100% 291.063281 496.635521</span></span></code></pre></div>
<p>The rule to apply is expressed as follow:</p>
<blockquote>
<p>The diversion from “54001” is computed to maintain a minimum flow of
5.3 m3/s at the gauging station “54029”. The diversion is allowed as far
as the flow at the gauging station “54001” is above 11.5 m3/s.</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="network">Network<a class="anchor" aria-label="anchor" href="#network"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">nodes_div</span> <span class="op">&lt;-</span> <span class="va">Severn</span><span class="op">$</span><span class="va">BasinsInfo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gauge_id"</span>, <span class="st">"downstream_id"</span>, <span class="st">"distance_downstream"</span>, <span class="st">"area"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">nodes_div</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"RunModel_GR4J"</span></span>
<span><span class="va">nodes_div</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">nodes_div</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>gauge_id <span class="op">=</span> <span class="st">"54001"</span>,</span>
<span>                                         downstream_id <span class="op">=</span> <span class="st">"54029"</span>,</span>
<span>                                         distance_downstream <span class="op">=</span> <span class="fl">25</span>,</span>
<span>                                         model <span class="op">=</span> <span class="st">"Diversion"</span>,</span>
<span>                                         area <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">renameCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"gauge_id"</span>, down <span class="op">=</span> <span class="st">"downstream_id"</span>, length <span class="op">=</span> <span class="st">"distance_downstream"</span><span class="op">)</span></span>
<span><span class="va">griwrmV06</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateGRiwrm.html">CreateGRiwrm</a></span><span class="op">(</span><span class="va">nodes_div</span>, <span class="va">renameCols</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">griwrmV06</span><span class="op">)</span></span></code></pre></div>
<p><img src="V06_Modelling_regulated_diversion_files/figure-html/unnamed-chunk-3-1.png" width="70%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="griwrminputsmodel-object">GRiwrmInputsModel object<a class="anchor" aria-label="anchor" href="#griwrminputsmodel-object"></a>
</h2>
<p>We produce below the same operations as in the vignette
“V02_Calibration_SD_model” to prepare the input data:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Severn</span><span class="op">)</span></span>
<span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="va">Severn</span><span class="op">$</span><span class="va">BasinsInfo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gauge_id"</span>, <span class="st">"downstream_id"</span>, <span class="st">"distance_downstream"</span>, <span class="st">"area"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">nodes</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"RunModel_GR4J"</span></span>
<span><span class="va">griwrm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateGRiwrm.html">CreateGRiwrm</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"gauge_id"</span>, down <span class="op">=</span> <span class="st">"downstream_id"</span>, length <span class="op">=</span> <span class="st">"distance_downstream"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">BasinsObs</span> <span class="op">&lt;-</span> <span class="va">Severn</span><span class="op">$</span><span class="va">BasinsObs</span></span>
<span><span class="va">DatesR</span> <span class="op">&lt;-</span> <span class="va">BasinsObs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">DatesR</span></span>
<span><span class="va">PrecipTot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">BasinsObs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">$</span><span class="va">precipitation</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">PotEvapTot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">BasinsObs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">$</span><span class="va">peti</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ConvertMeteoSD.html">ConvertMeteoSD</a></span><span class="op">(</span><span class="va">griwrm</span>, <span class="va">PrecipTot</span><span class="op">)</span></span>
<span><span class="va">PotEvap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ConvertMeteoSD.html">ConvertMeteoSD</a></span><span class="op">(</span><span class="va">griwrm</span>, <span class="va">PotEvapTot</span><span class="op">)</span></span></code></pre></div>
<p>The main difference here is that we need to provide a diverted flow
and a minimum remaining flow at station “54029”. As, the diverted flow
will be calculated during simulation, we provide a initial diverted flow
equals to zero for all the time steps.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qdiv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">DatesR</span><span class="op">)</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Qdiv</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"54001"</span></span>
<span><span class="va">Qmin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">11.5</span> <span class="op">*</span> <span class="fl">86400</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">DatesR</span><span class="op">)</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Qmin</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"54001"</span></span>
<span><span class="va">IM_div</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateInputsModel.html">CreateInputsModel</a></span><span class="op">(</span><span class="va">griwrmV06</span>, <span class="va">DatesR</span>, <span class="va">Precip</span>, <span class="va">PotEvap</span>, Qobs <span class="op">=</span> <span class="va">Qdiv</span>, Qmin <span class="op">=</span> <span class="va">Qmin</span><span class="op">)</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54095...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54002...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54001...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54029...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54032...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54057...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="implementation-of-the-regulation-controller">Implementation of the regulation controller<a class="anchor" aria-label="anchor" href="#implementation-of-the-regulation-controller"></a>
</h2>
<div class="section level3">
<h3 id="the-supervisor">The supervisor<a class="anchor" aria-label="anchor" href="#the-supervisor"></a>
</h3>
<p>The simulation is piloted through a <code>Supervisor</code> that can
contain one or more <code>Controller</code>. The supervision time step
will be here the same as the simulation time step: 1 day. Each day, the
decision is taken for the current day from the measurement simulated the
previous time step.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateSupervisor.html">CreateSupervisor</a></span><span class="op">(</span><span class="va">IM_div</span>, TimeStep <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-control-logic-function">The control logic function<a class="anchor" aria-label="anchor" href="#the-control-logic-function"></a>
</h3>
<p>On a Diversion node, the minimum remaining flow is provided with the
inputs and is automatically taken into account by the model. So the
control logic function has only to take care about how much water to
divert to the gauging station “54002”.</p>
<p>We need to enclose the logic function in a function factory providing
the Supervisor in the environment of the function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @param sv the Supervisor environment</span></span>
<span><span class="va">logicFunFactory</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">#' @param Y Flow measured at "54002" the previous time step</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Qnat</span> <span class="op">&lt;-</span> <span class="va">Y</span></span>
<span>    <span class="co">#  We need to remove the diverted flow to compute the natural flow at "54002"</span></span>
<span>    <span class="va">lastU</span> <span class="op">&lt;-</span> <span class="va">sv</span><span class="op">$</span><span class="va">controllers</span><span class="op">[[</span><span class="va">sv</span><span class="op">$</span><span class="va">controller.id</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">U</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lastU</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">Qnat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">Y</span> <span class="op">+</span> <span class="va">lastU</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">5.3</span> <span class="op">*</span> <span class="fl">86400</span> <span class="op">-</span> <span class="va">Qnat</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-controller">The controller<a class="anchor" aria-label="anchor" href="#the-controller"></a>
</h3>
<p>We declare the controller which defines where is the measurement
<code>Y</code> , where to apply the decision <code>U</code> with which
logic function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/CreateController.html">CreateController</a></span><span class="op">(</span><span class="va">sv</span>,</span>
<span>                 ctrl.id <span class="op">=</span> <span class="st">"Low flow support"</span>,</span>
<span>                 Y <span class="op">=</span> <span class="st">"54029"</span>,</span>
<span>                 U <span class="op">=</span> <span class="st">"54001"</span>,</span>
<span>                 FUN <span class="op">=</span> <span class="fu">logicFunFactory</span><span class="op">(</span><span class="va">sv</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; The controller 'Low flow support' has been added to the supervisor</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="running-the-simulation">Running the simulation<a class="anchor" aria-label="anchor" href="#running-the-simulation"></a>
</h2>
<p>First we need to create a <code>GRiwrmRunOptions</code> object and
load the parameters calibrated in the vignette
“V02_Calibration_SD_model”:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Running simulation on year 2003</span></span>
<span><span class="va">IndPeriod_Run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span></span>
<span>  <span class="va">DatesR</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2003-03-01"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="va">DatesR</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2004-01-01"</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">IndPeriod_WarmUp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">IndPeriod_Run</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">366</span>,<span class="va">IndPeriod_Run</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">RunOptions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateRunOptions.html">CreateRunOptions</a></span><span class="op">(</span><span class="va">IM_div</span>,</span>
<span>                               IndPeriod_WarmUp <span class="op">=</span> <span class="va">IndPeriod_WarmUp</span>,</span>
<span>                               IndPeriod_Run <span class="op">=</span> <span class="va">IndPeriod_Run</span><span class="op">)</span></span>
<span><span class="va">ParamV02</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"vignettes"</span>, <span class="st">"ParamV02.RDS"</span>, package <span class="op">=</span> <span class="st">"airGRiwrm"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The node “54029” was initially an upstream node. As it receives water
from “54001” it is no longer an upstream node and needs a parameter for
routing its upstream flows. We arbitrary say that the velocity in the
channel between “54001” and “54029” is 1 m/s.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ParamV02</span><span class="op">$</span><span class="va">`54029`</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">ParamV02</span><span class="op">$</span><span class="va">`54029`</span><span class="op">)</span></span></code></pre></div>
<p>And we run the supervised model:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OM_div</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunModel.html">RunModel</a></span><span class="op">(</span><span class="va">sv</span>, RunOptions <span class="op">=</span> <span class="va">RunOptions</span>, Param <span class="op">=</span> <span class="va">ParamV02</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing: 0% 10% 20% 30% 40% 50% 60% 70% 80% 90% 100%</span></span></code></pre></div>
<p>To compare results with diversion and without diversion, we run the
model without the supervision (remember that we have set the diverted
flow at zero in the inputs):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OM_nat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunModel.html">RunModel</a></span><span class="op">(</span><span class="va">IM_div</span>, RunOptions <span class="op">=</span> <span class="va">RunOptions</span>, Param <span class="op">=</span> <span class="va">ParamV02</span><span class="op">)</span></span>
<span><span class="co">#&gt; RunModel.GRiwrmInputsModel: Processing sub-basin 54095...</span></span>
<span><span class="co">#&gt; RunModel.GRiwrmInputsModel: Processing sub-basin 54002...</span></span>
<span><span class="co">#&gt; RunModel.GRiwrmInputsModel: Processing sub-basin 54001...</span></span>
<span><span class="co">#&gt; RunModel.GRiwrmInputsModel: Processing sub-basin 54029...</span></span>
<span><span class="co">#&gt; RunModel.GRiwrmInputsModel: Processing sub-basin 54032...</span></span>
<span><span class="co">#&gt; RunModel.GRiwrmInputsModel: Processing sub-basin 54057...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-results">Exploring results<a class="anchor" aria-label="anchor" href="#exploring-results"></a>
</h2>
<p>Let’s plot the diverted flow, and compare the flow at stations 54029
and 54001, with and without low-flow support at station 54001:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfQdiv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>DatesR <span class="op">=</span> <span class="va">OM_div</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">DatesR</span>,</span>
<span>                     Diverted_flow <span class="op">=</span> <span class="va">OM_div</span><span class="op">$</span><span class="va">`54001`</span><span class="op">$</span><span class="va">Qdiv_m3</span> <span class="op">/</span> <span class="fl">86400</span><span class="op">)</span></span>
<span></span>
<span><span class="va">oldpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.5</span>,<span class="fl">4</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.Qm3s.html">plot.Qm3s</a></span><span class="op">(</span><span class="va">dfQdiv</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot natural and influenced flow at station "54001" and "54029"</span></span>
<span><span class="va">thresholds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"54001"</span> <span class="op">=</span> <span class="fl">11.5</span>, <span class="st">"54029"</span> <span class="op">=</span> <span class="fl">5.3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">thresholds</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">OM_div</span>, <span class="st">"Qm3s"</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DatesR"</span>, <span class="va">id</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">OM_nat</span>, <span class="st">"Qm3s"</span><span class="op">)</span><span class="op">[</span>, <span class="va">id</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DatesR"</span>, </span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">id</span>, <span class="st">"with low-flow support"</span><span class="op">)</span>, </span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">id</span>, <span class="st">"natural flow"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/plot.Qm3s.html">plot.Qm3s</a></span><span class="op">(</span><span class="va">df</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"solid"</span>, <span class="st">"dashed"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">thresholds</span><span class="op">[</span><span class="va">id</span><span class="op">]</span>, col <span class="op">=</span> <span class="st">"green"</span>, lty <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="V06_Modelling_regulated_diversion_files/figure-html/unnamed-chunk-13-1.png" width="70%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by David Dorchies.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
