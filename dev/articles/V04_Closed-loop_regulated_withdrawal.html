<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Severn_04: Modelling a regulated withdrawal (closed-loop control) • airGRiwrm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Severn_04: Modelling a regulated withdrawal (closed-loop control)">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">airGRiwrm</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.6.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/airGRiwrm.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    </li>
<li class="dropdown-header">Quick start on the Severn River (UK)</li>
    <li>
      <a href="../articles/V01_Structure_SD_model.html">Severn_01: Set up of a semi-distributed GR model network</a>
    </li>
    <li>
      <a href="../articles/V02_Calibration_SD_model.html">Severn_02: Calibration of a GR4J semi-distributed model network</a>
    </li>
    <li>
      <a href="../articles/V03_Open-loop_influenced_flow.html">Severn_03: Calibration of an open-loop influenced flow model network</a>
    </li>
    <li>
      <a href="../articles/V04_Closed-loop_regulated_withdrawal.html">Severn_04: Modelling a regulated withdrawal (closed-loop control)</a>
    </li>
    <li>
      <a href="../articles/V05_Modelling_ungauged_nodes.html">Severn_05: Modelling ungauged stations</a>
    </li>
    <li>
      <a href="../articles/V06_Modelling_regulated_diversion.html">Severn_06: Modelling a regulated diversion</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Example of a large network on the Seine River (France)</li>
    <li>
      <a href="../articles/seinebasin/V01_First_network.html">Seine_01: Structuration of a semi-distributed GR4J model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V02_First_run.html">Seine_02: Run a semi-distributed GR model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V03_First_Calibration.html">Seine_03: Calibration of a semi-distributed GR model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V04_Open-loop_influenced_flow.html">Seine_04: Running open-loop influenced flow semi-distributed model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V05_Open-loop_influenced_flow_calibration.html">Seine_05: Calibration of an open-loop influenced flow semi-distributed model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V05b_Open-loop_influenced_flow_calibration_GR6J.html">Seine_05b: Calibration of an open-loop influenced flow semi-distributed GR6J model network</a>
    </li>
    <li>
      <a href="../articles/seinebasin/V06_Naturalised_flow_simulation.html">Seine_06: Simulate naturalized flows with a model network calibrated with influenced flows</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    airGR Galaxy

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://hydrogr.github.io/airGR/" class="external-link">airGR</a>
    </li>
    <li>
      <a href="https://CRAN.R-project.org/package=airGRdatassim" class="external-link">airGRdatassim R-package</a>
    </li>
    <li>
      <a href="https://sunshine.irstea.fr/app/airGRmaps" class="external-link">airGRmaps web app</a>
    </li>
    <li>
      <a href="https://hydroGR.github.io/airGRteaching/" class="external-link">airGRteaching R-package</a>
    </li>
    <li>
      <a href="https://sunshine.irstea.fr/app/airGRteaching" class="external-link">airGRteaching web app</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/inrae/airGRiwrm" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
<li>
  <a href="https://gitlab.irstea.fr/in-wop/airGRiwrm" class="external-link">
    <span class="fab fa-gitlab fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Severn_04: Modelling a regulated withdrawal
(closed-loop control)</h1>
                        <h4 data-toc-skip class="author">David
Dorchies</h4>
            
      
      <small class="dont-index">Source: <a href="https://gitlab.irstea.fr/in-wop/airGRiwrm/-/blob/master/vignettes/V04_Closed-loop_regulated_withdrawal.Rmd" class="external-link"><code>vignettes/V04_Closed-loop_regulated_withdrawal.Rmd</code></a></small>
      <div class="hidden name"><code>V04_Closed-loop_regulated_withdrawal.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inrae.github.io/airGRiwrm/">airGRiwrm</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: airGR</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'airGRiwrm'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:airGR':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Calibration, CreateCalibOptions, CreateInputsCrit,</span></span>
<span><span class="co">#&gt;     CreateInputsModel, CreateRunOptions, RunModel</span></span></code></pre></div>
<div class="section level2">
<h2 id="presentation-of-the-case-study">Presentation of the case study<a class="anchor" aria-label="anchor" href="#presentation-of-the-case-study"></a>
</h2>
<p>Starting from the network and the calibration set in the vignette
“V02_Calibration_SD_model”, we add 2 intake points for irrigation.</p>
<div class="section level3">
<h3 id="network-configuration">Network configuration<a class="anchor" aria-label="anchor" href="#network-configuration"></a>
</h3>
<p>The following code chunk resumes the procedure of the vignette
“V02_Calibration_SD_model”:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Severn</span><span class="op">)</span></span>
<span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="va">Severn</span><span class="op">$</span><span class="va">BasinsInfo</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gauge_id"</span>, <span class="st">"downstream_id"</span>, <span class="st">"distance_downstream"</span>, <span class="st">"area"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">nodes</span><span class="op">$</span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">"RunModel_GR4J"</span></span></code></pre></div>
<p>The intake points are located:</p>
<ul>
<li>on the Severn at 35 km upstream Bewdley (Gauging station
‘54001’);</li>
<li>on the Severn at 10 km upstream Saxons Lode (Gauging station
‘54032’).</li>
</ul>
<p>We have to add this 2 nodes in the network:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">nodes</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    gauge_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Irrigation1"</span>, <span class="st">"Irrigation2"</span><span class="op">)</span>,</span>
<span>    downstream_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"54001"</span>, <span class="st">"54032"</span><span class="op">)</span>,</span>
<span>    distance_downstream <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">35</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>    model <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    area <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nodes</span></span>
<span><span class="co">#&gt;      gauge_id downstream_id distance_downstream    area         model</span></span>
<span><span class="co">#&gt; 1       54057          &lt;NA&gt;                  NA 9885.46 RunModel_GR4J</span></span>
<span><span class="co">#&gt; 2       54032         54057                  15 6864.88 RunModel_GR4J</span></span>
<span><span class="co">#&gt; 3       54001         54032                  45 4329.90 RunModel_GR4J</span></span>
<span><span class="co">#&gt; 4       54095         54001                  42 3722.68 RunModel_GR4J</span></span>
<span><span class="co">#&gt; 5       54002         54057                  43 2207.95 RunModel_GR4J</span></span>
<span><span class="co">#&gt; 6       54029         54032                  32 1483.65 RunModel_GR4J</span></span>
<span><span class="co">#&gt; 7 Irrigation1         54001                  35      NA          &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 8 Irrigation2         54032                  10      NA          &lt;NA&gt;</span></span></code></pre></div>
<p>And we create the <code>GRiwrm</code> object from this new
network:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">griwrmV04</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateGRiwrm.html">CreateGRiwrm</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id <span class="op">=</span> <span class="st">"gauge_id"</span>, down <span class="op">=</span> <span class="st">"downstream_id"</span>, length <span class="op">=</span> <span class="st">"distance_downstream"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">griwrmV04</span><span class="op">)</span></span></code></pre></div>
<p><img src="V04_Closed-loop_regulated_withdrawal_files/figure-html/griwm-1.png" width="70%" style="display: block; margin: auto;"></p>
<p>Blue nodes figure upstream basins (rainfall-runoff modeling only) and
green nodes figure intermediate basins, coupling rainfall-runoff and
hydraulic routing modeling. Nodes in red color are direct injection
points (positive or negative flow) in the model.</p>
<p>It’s important to notice that even if the points “Irrigation1” and
“Irrigation2” are physically located on a single branch of the Severn
river as well as gauging stations “54095”, “54001” and “54032”, nodes
“Irrigation1” and “Irrigation2” are not represented on the same branch
in this conceptual model. Consequently, with this network configuration,
it is not possible to know the value of the flow in the Severn river at
the “Irrigation1” or “Irrigation2” nodes. These values are only
available in nodes “54095”, “54001” and “54032” where rainfall-runoff
and hydraulic routing are actually modeled.</p>
</div>
<div class="section level3">
<h3 id="irrigation-objectives-and-flow-demand-at-intakes">Irrigation objectives and flow demand at intakes<a class="anchor" aria-label="anchor" href="#irrigation-objectives-and-flow-demand-at-intakes"></a>
</h3>
<p>Irrigation1 covers an area of 15 km² and Irrigation2 covers an area
of 30 km².</p>
<p>The objective of these irrigation systems is to cover the rainfall
deficit <span class="citation">(Burt et al. 1997)</span> with 80% of
success. Below is the calculation of the 8<sup>th</sup> decile of
monthly water needed given meteorological data of catchments “54001” and
“54032” (unit mm/day) :</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Formatting climatic data for CreateInputsModel (See vignette V01_Structure_SD_model for details)</span></span>
<span><span class="va">BasinsObs</span> <span class="op">&lt;-</span> <span class="va">Severn</span><span class="op">$</span><span class="va">BasinsObs</span></span>
<span><span class="va">DatesR</span> <span class="op">&lt;-</span> <span class="va">BasinsObs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">DatesR</span></span>
<span><span class="va">PrecipTot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">BasinsObs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">$</span><span class="va">precipitation</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">PotEvapTot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">BasinsObs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">$</span><span class="va">peti</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Qobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">BasinsObs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="va">x</span><span class="op">$</span><span class="va">discharge_spec</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Precip</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ConvertMeteoSD.html">ConvertMeteoSD</a></span><span class="op">(</span><span class="va">griwrmV04</span>, <span class="va">PrecipTot</span><span class="op">)</span></span>
<span><span class="va">PotEvap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ConvertMeteoSD.html">ConvertMeteoSD</a></span><span class="op">(</span><span class="va">griwrmV04</span>, <span class="va">PotEvapTot</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculation of the water need at the sub-basin scale</span></span>
<span><span class="va">dailyWaterNeed</span> <span class="op">&lt;-</span> <span class="va">PotEvap</span> <span class="op">-</span> <span class="va">Precip</span></span>
<span><span class="va">dailyWaterNeed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">DatesR</span><span class="op">)</span>, <span class="va">dailyWaterNeed</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"54001"</span>, <span class="st">"54032"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">monthlyWaterNeed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/airGR/man/SeriesAggreg.html" class="external-link">SeriesAggreg</a></span><span class="op">(</span><span class="va">dailyWaterNeed</span>, <span class="st">"%Y%m"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"mean"</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">monthlyWaterNeed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/airGR/man/SeriesAggreg.html" class="external-link">SeriesAggreg</a></span><span class="op">(</span><span class="va">dailyWaterNeed</span>, <span class="st">"%m"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"q80"</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">monthlyWaterNeed</span><span class="op">[</span><span class="va">monthlyWaterNeed</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">monthlyWaterNeed</span><span class="op">$</span><span class="va">DatesR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">monthlyWaterNeed</span><span class="op">$</span><span class="va">DatesR</span>,<span class="st">"%m"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">monthlyWaterNeed</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"month"</span></span>
<span><span class="va">monthlyWaterNeed</span> <span class="op">&lt;-</span> <span class="va">monthlyWaterNeed</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">monthlyWaterNeed</span><span class="op">$</span><span class="va">month</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">monthlyWaterNeed</span></span>
<span><span class="co">#&gt;       month     54001     54032</span></span>
<span><span class="co">#&gt; 25        1 0.2400000 0.2365627</span></span>
<span><span class="co">#&gt; 1721      2 0.5918416 0.6188486</span></span>
<span><span class="co">#&gt; 2804      3 1.2376475 1.2384480</span></span>
<span><span class="co">#&gt; 3745      4 2.1809664 2.2036046</span></span>
<span><span class="co">#&gt; 4721      5 3.0230456 3.0555408</span></span>
<span><span class="co">#&gt; 5716      6 3.4775922 3.5096402</span></span>
<span><span class="co">#&gt; 6722      7 3.5305228 3.5769480</span></span>
<span><span class="co">#&gt; 7644      8 2.6925228 2.7331421</span></span>
<span><span class="co">#&gt; 8637      9 1.8323644 1.8489218</span></span>
<span><span class="co">#&gt; 9588     10 0.8626301 0.8867260</span></span>
<span><span class="co">#&gt; 10554    11 0.2707842 0.2497664</span></span>
<span><span class="co">#&gt; 11491    12 0.1488753 0.1665834</span></span></code></pre></div>
<p>We restrict the irrigation season between March and September As a
consequence, the crop requirement can be expressed in m<sup>3</sup>/s as
follows:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">irrigationObjective</span> <span class="op">&lt;-</span> <span class="va">monthlyWaterNeed</span></span>
<span><span class="co"># Conversion in m3/day</span></span>
<span><span class="va">irrigationObjective</span><span class="op">$</span><span class="st">"54001"</span> <span class="op">&lt;-</span> <span class="va">monthlyWaterNeed</span><span class="op">$</span><span class="st">"54001"</span> <span class="op">*</span> <span class="fl">15</span> <span class="op">*</span> <span class="fl">1E3</span></span>
<span><span class="va">irrigationObjective</span><span class="op">$</span><span class="st">"54032"</span> <span class="op">&lt;-</span> <span class="va">monthlyWaterNeed</span><span class="op">$</span><span class="st">"54032"</span> <span class="op">*</span> <span class="fl">30</span> <span class="op">*</span> <span class="fl">1E3</span></span>
<span><span class="co"># Irrigation period between March and September</span></span>
<span><span class="va">irrigationObjective</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">9</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="co"># Conversion in m3/s</span></span>
<span><span class="va">irrigationObjective</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">irrigationObjective</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="fl">86400</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">irrigationObjective</span><span class="op">$</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">irrigationObjective</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">irrigationObjective</span></span>
<span><span class="co">#&gt;       month 54001 54032 total</span></span>
<span><span class="co">#&gt; 25        1   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 1721      2   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 2804      3   0.2   0.4   0.6</span></span>
<span><span class="co">#&gt; 3745      4   0.4   0.8   1.2</span></span>
<span><span class="co">#&gt; 4721      5   0.5   1.1   1.6</span></span>
<span><span class="co">#&gt; 5716      6   0.6   1.2   1.8</span></span>
<span><span class="co">#&gt; 6722      7   0.6   1.2   1.8</span></span>
<span><span class="co">#&gt; 7644      8   0.5   0.9   1.4</span></span>
<span><span class="co">#&gt; 8637      9   0.3   0.6   0.9</span></span>
<span><span class="co">#&gt; 9588     10   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 10554    11   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 11491    12   0.0   0.0   0.0</span></span></code></pre></div>
<p>We assume that the efficiency of the irrigation systems is equal to
50% as proposed by <span class="citation">Seckler, Molden, and
Sakthivadivel (2003)</span>. as a consequence, the flow demand at intake
for each irrigation system is as follows (unit: m<sup>3</sup>/s):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Application of the 50% irrigation system efficiency on the water demand</span></span>
<span><span class="va">irrigationObjective</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">irrigationObjective</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="fl">0.5</span></span>
<span><span class="co"># Display result in m3/s</span></span>
<span><span class="va">irrigationObjective</span></span>
<span><span class="co">#&gt;       month 54001 54032 total</span></span>
<span><span class="co">#&gt; 25        1   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 1721      2   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 2804      3   0.4   0.8   1.2</span></span>
<span><span class="co">#&gt; 3745      4   0.8   1.6   2.4</span></span>
<span><span class="co">#&gt; 4721      5   1.0   2.2   3.2</span></span>
<span><span class="co">#&gt; 5716      6   1.2   2.4   3.6</span></span>
<span><span class="co">#&gt; 6722      7   1.2   2.4   3.6</span></span>
<span><span class="co">#&gt; 7644      8   1.0   1.8   2.8</span></span>
<span><span class="co">#&gt; 8637      9   0.6   1.2   1.8</span></span>
<span><span class="co">#&gt; 9588     10   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 10554    11   0.0   0.0   0.0</span></span>
<span><span class="co">#&gt; 11491    12   0.0   0.0   0.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="restriction-of-irrigation-in-case-of-water-scarcity">Restriction of irrigation in case of water scarcity<a class="anchor" aria-label="anchor" href="#restriction-of-irrigation-in-case-of-water-scarcity"></a>
</h3>
<div class="section level4">
<h4 id="minimal-environmental-flow-at-the-intakes">Minimal environmental flow at the intakes<a class="anchor" aria-label="anchor" href="#minimal-environmental-flow-at-the-intakes"></a>
</h4>
<p>In the UK, abstraction restrictions are driven by Environmental Flow
Indicator (EFI) supporting Good Ecological Status (GES) <span class="citation">(Klaar et al. 2014)</span>. Abstraction restriction
consists in limiting the proportion of available flow for abstraction in
function of the current flow regime (Reference taken for a river that is
highly sensitive to abstraction classified “ASB3”).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">restriction_rule</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>quantile_natural_flow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>, <span class="fl">.3</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>                               abstraction_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="fl">0.20</span>, <span class="fl">0.24</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The control of the abstraction will be done at the gauging station
downstream all the abstraction locations (node “54032”). So we need the
flow corresponding to the quantiles of natural flow and flow available
for abstraction in each case.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quant_m3s32</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span></span>
<span>  <span class="va">Qobs</span><span class="op">[</span>,<span class="st">"54032"</span><span class="op">]</span> <span class="op">*</span> <span class="va">griwrmV04</span><span class="op">[</span><span class="va">griwrmV04</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="st">"54032"</span>, <span class="st">"area"</span><span class="op">]</span> <span class="op">/</span> <span class="fl">86.4</span>,</span>
<span>  <span class="va">restriction_rule</span><span class="op">$</span><span class="va">quantile_natural_flow</span>,</span>
<span>  na.rm <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">restriction_rule_m3s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  threshold_natural_flow <span class="op">=</span> <span class="va">quant_m3s32</span>,</span>
<span>  abstraction_rate <span class="op">=</span> <span class="va">restriction_rule</span><span class="op">$</span><span class="va">abstraction_rate</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">restriction_rule</span><span class="op">$</span><span class="va">quantile_natural_flow</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">restriction_rule_m3s</span><span class="op">$</span><span class="va">threshold_natural_flow</span>,</span>
<span>              <span class="va">restriction_rule</span><span class="op">$</span><span class="va">abstraction_rate</span> <span class="op">*</span> <span class="va">restriction_rule_m3s</span><span class="op">$</span><span class="va">threshold_natural_flow</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">irrigationObjective</span><span class="op">$</span><span class="va">total</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        log <span class="op">=</span> <span class="st">"x"</span>, type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>        main <span class="op">=</span> <span class="st">"Quantiles of flow on the Severn at Saxons Lode (54032)"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"quantiles"</span>, ylab <span class="op">=</span> <span class="st">"Flow (m3/s)"</span>,</span>
<span>        lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fl">3</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Natural flow"</span>, <span class="st">"Abstraction limit"</span>, <span class="st">"Irrigation max. objective"</span><span class="op">)</span>,</span>
<span>       col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="fl">3</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="V04_Closed-loop_regulated_withdrawal_files/figure-html/unnamed-chunk-4-1.png" width="70%" style="display: block; margin: auto;"></p>
<p>The water availability or abstraction restriction depending on the
natural flow is calculated with the function below:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A function to enclose the parameters in the function (See: http://adv-r.had.co.nz/Functional-programming.html#closures)</span></span>
<span><span class="va">getAvailableAbstractionEnclosed</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">restriction_rule_m3s</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">Qnat</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="va">restriction_rule_m3s</span><span class="op">$</span><span class="va">threshold_natural_flow</span>,</span>
<span>                        <span class="va">restriction_rule_m3s</span><span class="op">$</span><span class="va">abstraction_rate</span>,</span>
<span>                        <span class="va">Qnat</span>,</span>
<span>                        rule <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># The function with the parameters inside it :)</span></span>
<span><span class="va">getAvailableAbstraction</span> <span class="op">&lt;-</span> <span class="fu">getAvailableAbstractionEnclosed</span><span class="op">(</span><span class="va">restriction_rule_m3s</span><span class="op">)</span></span>
<span><span class="co"># You can check the storage of the parameters in the function with</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">getAvailableAbstraction</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $restriction_rule_m3s</span></span>
<span><span class="co">#&gt;     threshold_natural_flow abstraction_rate</span></span>
<span><span class="co">#&gt; 5%                15.09638             0.10</span></span>
<span><span class="co">#&gt; 30%               30.19276             0.15</span></span>
<span><span class="co">#&gt; 50%               50.85096             0.20</span></span>
<span><span class="co">#&gt; 70%               90.57828             0.24</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="restriction-rules">Restriction rules<a class="anchor" aria-label="anchor" href="#restriction-rules"></a>
</h4>
<p>The figure above shows that restrictions will be imposed to the
irrigation perimeter if the natural flow at Saxons Lode
(<code>54032</code>) is under around 20 m<sup>3</sup>/s.</p>
<p>Applying restriction on the intake on a real field is always
challenging since it is difficult to regulate day by day the flow at the
intake. Policy makers often decide to close the irrigation abstraction
points in turn several days a week based on the mean flow of the
previous week.</p>
<p>The number of authorized days per week for irrigation can be
calculated as follows. All calculations are based on the mean flow
measured the week previous the current time step. First, the naturalized
flow
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
is equal to</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>M</mi><mo>+</mo><msub><mi>I</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex"> N = M + I_l </annotation></semantics></math>
with:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>,
the measured flow at the downstream gauging station</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mi>l</mi></msub><annotation encoding="application/x-tex">I_l</annotation></semantics></math>,
the total abstracted flow for irrigation for the last week</li>
</ul>
<p>Available flow for abstraction
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
is:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><msub><mi>f</mi><mi>a</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">A = f_{a}(N)</annotation></semantics></math></p>
<p>with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>a</mi></msub><annotation encoding="application/x-tex">f_a</annotation></semantics></math>
the availability function calculated from quantiles of natural flow and
related restriction rates.</p>
<p>The flow planned for irrigation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Ip</annotation></semantics></math>
is then:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>p</mi></msub><mo>=</mo><mo>min</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>O</mi><mo>,</mo><mi>A</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex"> I_p = \min (O, A)</annotation></semantics></math></p>
<p>with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>O</mi><annotation encoding="application/x-tex">O</annotation></semantics></math>
the irrigation objective flow.</p>
<p>The number of days for irrigation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
per week is then equal to:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mo stretchy="false" form="prefix">⌊</mo><mfrac><msub><mi>I</mi><mi>p</mi></msub><mi>O</mi></mfrac><mo>×</mo><mn>7</mn><mo stretchy="false" form="postfix">⌋</mo></mrow><annotation encoding="application/x-tex"> n = \lfloor \frac{I_p}{O} \times 7 \rfloor</annotation></semantics></math>
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">⌊</mo><mi>x</mi><mo stretchy="false" form="postfix">⌋</mo></mrow><annotation encoding="application/x-tex">\lfloor x \rfloor</annotation></semantics></math>
the function that returns the largest integers not greater than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math></p>
<p>The rotation of restriction days between the 2 irrigation perimeters
is operated as follows:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">restriction_rotation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">7</span>,<span class="fl">6</span>,<span class="fl">4</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">4</span>,<span class="fl">6</span>,<span class="fl">7</span>,<span class="fl">5</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>  <span class="va">rbind</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">b</span> <span class="op">&lt;-</span> <span class="va">restriction_rotation</span> <span class="op">&lt;=</span> <span class="va">x</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Display the planning of restriction</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">heat.colors</a></span><span class="op">(</span><span class="fl">3</span>, rev <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      axes <span class="op">=</span> <span class="cn">FALSE</span>, xlab <span class="op">=</span> <span class="st">"week day"</span>, ylab <span class="op">=</span> <span class="st">"number of restriction days"</span>,</span>
<span>      main <span class="op">=</span> <span class="st">"Number of closed irrigation perimeters"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="st">"SMTWTFS"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">y</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">m</span><span class="op">[</span><span class="va">y</span>,<span class="va">x</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="V04_Closed-loop_regulated_withdrawal_files/figure-html/unnamed-chunk-6-1.png" width="70%" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="implementation-of-the-model">Implementation of the model<a class="anchor" aria-label="anchor" href="#implementation-of-the-model"></a>
</h2>
<p>As for the previous model, we need to set up an
<code>GRiwrmInputsModel</code> object containing all the model
inputs:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Flow time series are needed for all direct injection nodes in the network</span></span>
<span><span class="co"># even if they may be overwritten after by a controller</span></span>
<span><span class="va">QinfIrrig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Irrigation1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">DatesR</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        Irrigation2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">DatesR</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Creation of the GRiwrmInputsModel object</span></span>
<span><span class="va">IM_Irrig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateInputsModel.html">CreateInputsModel</a></span><span class="op">(</span><span class="va">griwrmV04</span>, <span class="va">DatesR</span>, <span class="va">Precip</span>, <span class="va">PotEvap</span>, <span class="va">QinfIrrig</span><span class="op">)</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54095...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54002...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54029...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54001...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54032...</span></span>
<span><span class="co">#&gt; CreateInputsModel.GRiwrm: Processing sub-basin 54057...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="implementation-of-the-regulation-controller">Implementation of the regulation controller<a class="anchor" aria-label="anchor" href="#implementation-of-the-regulation-controller"></a>
</h2>
<div class="section level3">
<h3 id="the-supervisor">The supervisor<a class="anchor" aria-label="anchor" href="#the-supervisor"></a>
</h3>
<p>The simulation is piloted through a <code>Supervisor</code> that can
contain one or more <code>Controller</code>. This supervisor will work
with a cycle of 7 days: the measurement are taken on the last 7 days and
decisions are taken for each time step for the next seven days.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateSupervisor.html">CreateSupervisor</a></span><span class="op">(</span><span class="va">IM_Irrig</span>, TimeStep <span class="op">=</span> <span class="fl">7L</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-control-logic-function">The control logic function<a class="anchor" aria-label="anchor" href="#the-control-logic-function"></a>
</h3>
<p>We need a controller that measures the flow at Saxons Lode (“54032”)
and adapts on a weekly basis the abstracted flow at the two irrigation
points. The supervisor will stop the simulation every 7 days and will
provide to the controller the last 7 simulated flow values at Saxons
Lode (“54032”) (measured variables) and the controller should provide
“command variables” for the next 7 days for the 2 irrigation points.</p>
<p>A control logic function should be provided to the controller. This
control logic function processes the logic of the regulation taking
measured flows as input and returning the “command variables”. Both
measured variables and command variables are of type <code>matrix</code>
with the variables in columns and the time steps in rows.</p>
<p>In this example, the logic function must do the following tasks:</p>
<ol style="list-style-type: decimal">
<li>Calculate the objective of irrigation according to the month of the
current days of simulation</li>
<li>Calculate the naturalized flow from the measured flow and the
abstracted flow of the previous week</li>
<li>Calculate the number of days of restriction for each irrigation
point</li>
<li>Return the abstracted flow for the next week taking into account
restriction days</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fIrrigationFactory</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">supervisor</span>,</span>
<span>                               <span class="va">irrigationObjective</span>,</span>
<span>                               <span class="va">restriction_rule_m3s</span>,</span>
<span>                               <span class="va">restriction_rotation</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Y is in m3/day and the basin's area is in km2</span></span>
<span>    <span class="co"># Calculate the objective of irrigation according to the month of the current days of simulation</span></span>
<span>    <span class="va">month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">supervisor</span><span class="op">$</span><span class="va">ts.date</span>, <span class="st">"%m"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">U</span> <span class="op">&lt;-</span> <span class="va">irrigationObjective</span><span class="op">[</span><span class="va">month</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span> <span class="co"># m3/s</span></span>
<span>    <span class="va">meanU</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">meanU</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># calculate the naturalized flow from the measured flow and the abstracted flow of the previous week</span></span>
<span>      <span class="va">lastU</span> <span class="op">&lt;-</span> <span class="va">supervisor</span><span class="op">$</span><span class="va">controllers</span><span class="op">[[</span><span class="va">supervisor</span><span class="op">$</span><span class="va">controller.id</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">U</span> <span class="co"># m3/day</span></span>
<span>      <span class="va">Qnat</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">Y</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">lastU</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">86400</span> <span class="co"># m3/s</span></span>
<span>      <span class="co"># Maximum abstracted flow available</span></span>
<span>      <span class="va">Qrestricted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="va">restriction_rule_m3s</span><span class="op">$</span><span class="va">threshold_natural_flow</span>,</span>
<span>               <span class="va">restriction_rule_m3s</span><span class="op">$</span><span class="va">abstraction_rate</span>,</span>
<span>               <span class="va">Qnat</span>,</span>
<span>               rule <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">y</span> <span class="op">*</span> <span class="va">Qnat</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="co"># Total for irrigation</span></span>
<span>      <span class="va">QIrrig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">meanU</span>, <span class="va">Qrestricted</span><span class="op">)</span></span>
<span>      <span class="co"># Number of days of irrigation</span></span>
<span>      <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fl">7</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">QIrrig</span> <span class="op">/</span> <span class="va">meanU</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="co"># Apply days off</span></span>
<span>      <span class="va">U</span><span class="op">[</span><span class="va">restriction_rotation</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">U</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span> <span class="op">&lt;=</span> <span class="va">n</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">-</span><span class="va">U</span> <span class="op">*</span> <span class="fl">86400</span><span class="op">)</span> <span class="co"># withdrawal is a negative flow in m3/day on an upstream node</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>You can notice that the data required for processing the control
logic are enclosed in the function <code>fIrrigationFactory</code>,
which takes the required data as arguments and returns the control logic
function.</p>
<p>Creating <code>fIrrigation</code> by calling
<code>fIrrigationFactory</code> with the arguments currently in memory
saves these variables in the environment of the function:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fIrrigation</span> <span class="op">&lt;-</span> <span class="fu">fIrrigationFactory</span><span class="op">(</span>supervisor <span class="op">=</span> <span class="va">sv</span>,</span>
<span>                                  irrigationObjective <span class="op">=</span> <span class="va">irrigationObjective</span>,</span>
<span>                                  restriction_rule_m3s <span class="op">=</span> <span class="va">restriction_rule_m3s</span>,</span>
<span>                                  restriction_rotation <span class="op">=</span> <span class="va">restriction_rotation</span><span class="op">)</span></span></code></pre></div>
<p>You can see what data are available in the environment of the
function with:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">fIrrigation</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ supervisor          :Classes 'Supervisor', 'environment' &lt;environment: 0x55a9ede2bb68&gt; </span></span>
<span><span class="co">#&gt;  $ irrigationObjective :'data.frame':    12 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;   ..$ month: num [1:12] 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">#&gt;   ..$ 54001: num [1:12] 0 0 0.4 0.8 1 1.2 1.2 1 0.6 0 ...</span></span>
<span><span class="co">#&gt;   ..$ 54032: num [1:12] 0 0 0.8 1.6 2.2 2.4 2.4 1.8 1.2 0 ...</span></span>
<span><span class="co">#&gt;   ..$ total: num [1:12] 0 0 1.2 2.4 3.2 3.6 3.6 2.8 1.8 0 ...</span></span>
<span><span class="co">#&gt;  $ restriction_rule_m3s:'data.frame':    4 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;   ..$ threshold_natural_flow: num [1:4] 15.1 30.2 50.9 90.6</span></span>
<span><span class="co">#&gt;   ..$ abstraction_rate      : num [1:4] 0.1 0.15 0.2 0.24</span></span>
<span><span class="co">#&gt;  $ restriction_rotation: num [1:7, 1:2] 5 7 6 4 2 1 3 3 1 2 ...</span></span></code></pre></div>
<p>The <code>supervisor</code> variable is itself an environment which
means that the variables contained inside it will be updated during the
simulation. Some of them are useful for computing the control logic such
as:</p>
<ul>
<li>
<code>supervisor$ts.index</code>: indexes of the current time steps
of simulation (In <code>IndPeriod_Run</code>)</li>
<li>
<code>supervisor$ts.date</code>: date/time of the current time steps
of simulation</li>
<li>
<code>supervisor$controller.id</code>: identifier of the current
controller</li>
<li>
<code>supervisor$controllers</code>: the <code>list</code> of
<code>Controller</code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="the-controller">The controller<a class="anchor" aria-label="anchor" href="#the-controller"></a>
</h3>
<p>The controller contains:</p>
<ul>
<li>the location of the measured flows</li>
<li>the location of the control commands</li>
<li>the logic control function</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/CreateController.html">CreateController</a></span><span class="op">(</span><span class="va">sv</span>,</span>
<span>                 ctrl.id <span class="op">=</span> <span class="st">"Irrigation"</span>,</span>
<span>                 Y <span class="op">=</span> <span class="st">"54032"</span>,</span>
<span>                 U <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Irrigation1"</span>, <span class="st">"Irrigation2"</span><span class="op">)</span>,</span>
<span>                 FUN <span class="op">=</span> <span class="va">fIrrigation</span><span class="op">)</span></span>
<span><span class="co">#&gt; The controller 'Irrigation' has been added to the supervisor</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="running-the-simulation">Running the simulation<a class="anchor" aria-label="anchor" href="#running-the-simulation"></a>
</h2>
<p>First we need to create a <code>GRiwrmRunOptions</code> object and
load the parameters calibrated in the vignette
“V02_Calibration_SD_model”:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">IndPeriod_Run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">DatesR</span> <span class="op">==</span> <span class="op">(</span><span class="va">DatesR</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">365</span><span class="op">*</span><span class="fl">24</span><span class="op">*</span><span class="fl">60</span><span class="op">*</span><span class="fl">60</span><span class="op">)</span><span class="op">)</span>, <span class="co"># Set aside warm-up period</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">DatesR</span><span class="op">)</span> <span class="co"># Until the end of the time series</span></span>
<span><span class="op">)</span></span>
<span><span class="va">IndPeriod_WarmUp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">IndPeriod_Run</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">RunOptions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateRunOptions.html">CreateRunOptions</a></span><span class="op">(</span><span class="va">IM_Irrig</span>,</span>
<span>                               IndPeriod_WarmUp <span class="op">=</span> <span class="va">IndPeriod_WarmUp</span>,</span>
<span>                               IndPeriod_Run <span class="op">=</span> <span class="va">IndPeriod_Run</span><span class="op">)</span></span>
<span><span class="va">ParamV02</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"vignettes"</span>, <span class="st">"ParamV02.RDS"</span>, package <span class="op">=</span> <span class="st">"airGRiwrm"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For running a model with a supervision, you only need to substitute
<code>InputsModel</code> by a <code>Supervisor</code> in the
<code>RunModel</code> function call.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OM_Irrig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunModel.html">RunModel</a></span><span class="op">(</span><span class="va">sv</span>, RunOptions <span class="op">=</span> <span class="va">RunOptions</span>, Param <span class="op">=</span> <span class="va">ParamV02</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing: 0% 10% 20% 30% 40% 50% 60% 70% 80% 90% 100%</span></span></code></pre></div>
<p>Simulated flows during irrigation season can be extracted and plot as
follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Qm3s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">OM_Irrig</span>, <span class="st">"Qm3s"</span><span class="op">)</span></span>
<span><span class="va">Qm3s</span> <span class="op">&lt;-</span> <span class="va">Qm3s</span><span class="op">[</span><span class="va">Qm3s</span><span class="op">$</span><span class="va">DatesR</span> <span class="op">&gt;</span> <span class="st">"2003-02-25"</span> <span class="op">&amp;</span> <span class="va">Qm3s</span><span class="op">$</span><span class="va">DatesR</span> <span class="op">&lt;</span> <span class="st">"2003-10-05"</span>,<span class="op">]</span></span>
<span><span class="va">oldpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.5</span>,<span class="fl">4</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Qm3s</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DatesR"</span>, <span class="st">"54095"</span>, <span class="st">"54001"</span>, <span class="st">"54032"</span><span class="op">)</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">""</span>, xlab <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Qm3s</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DatesR"</span>, <span class="st">"Irrigation1"</span>, <span class="st">"Irrigation2"</span><span class="op">)</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">""</span>, xlab <span class="op">=</span> <span class="st">""</span>, legend.x <span class="op">=</span> <span class="st">"bottomright"</span><span class="op">)</span></span></code></pre></div>
<p><img src="V04_Closed-loop_regulated_withdrawal_files/figure-html/unnamed-chunk-15-1.png" width="70%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">oldpar</span><span class="op">)</span></span></code></pre></div>
<p>We can observe that the irrigation points are alternatively closed
some days a week when the flow at node “54032” becomes low.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-burtIrrigationPerformanceMeasures1997" class="csl-entry">
Burt, C. M., A. J. Clemmens, T. S. Strelkoff, K. H. Solomon, R. D.
Bliesner, L. A. Hardy, T. A. Howell, and D. E. Eisenhauer. 1997.
<span>“Irrigation <span>Performance Measures</span>:
<span>Efficiency</span> and <span>Uniformity</span>.”</span> <em>Journal
of Irrigation and Drainage Engineering</em> 123 (6): 423–42. <a href="https://doi.org/10.1061/(ASCE)0733-9437(1997)123:6(423)" class="external-link">https://doi.org/10.1061/(ASCE)0733-9437(1997)123:6(423)</a>.
</div>
<div id="ref-klaarDevelopingHydroecologicalModels2014" class="csl-entry">
Klaar, Megan J., Michael J. Dunbar, Mark Warren, and Rob Soley. 2014.
<span>“Developing Hydroecological Models to Inform Environmental Flow
Standards: A Case Study from <span>England</span>.”</span> <em>WIREs
Water</em> 1 (2): 207–17. <a href="https://doi.org/10.1002/wat2.1012" class="external-link">https://doi.org/10.1002/wat2.1012</a>.
</div>
<div id="ref-secklerConceptEfficiencyWaterresources2003" class="csl-entry">
Seckler, D., D. Molden, and R. Sakthivadivel. 2003. <span>“The Concept
of Efficiency in Water-Resources Management and Policy.”</span> In
<em>Water Productivity in Agriculture: Limits and Opportunities for
Improvement</em>, edited by J. W. Kijne, R. Barker, and D. Molden,
37–51. <span>Wallingford</span>: <span>CABI</span>. <a href="https://doi.org/10.1079/9780851996691.0037" class="external-link">https://doi.org/10.1079/9780851996691.0037</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by David Dorchies.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
