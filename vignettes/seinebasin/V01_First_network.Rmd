---
title: 'Seine_01: Structuration of a semi-distributive GR4J model network'
author: "David Dorchies"
vignette: >
  %\VignetteIndexEntry{Seine_01: Structuration of a semi-distributive GR4J model network}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(airGRiwrm)
```


## Semi-distributive network description

List of nodes

```{r seine_nodes}
seine_nodes <- read.table(
  file = system.file("seine_data", "network_gauging_stations.txt", package = "seinebasin"),
  sep = ";", header = TRUE, fileEncoding = "UTF-8", quote = "\"", stringsAsFactors = FALSE
)
seine_nodes
```

Create the GRiwrm object which lists the nodes and describes the network diagram. It's a dataframe of class `GRiwrm` and `GRiwrm` with specific column names:

- `id`: the identifier of the node in the network.
- `down`: the identifier of the next hydrological node downstream.
- `length`: hydraulic distance to the next hydrological downstream node.
- `model`: Name of the hydrological model used (E.g. "RunModel_GR4J"). `NA` for other type of node.
- `area`: Area of the sub-catchment (km<sup>2</sup>). Used for hydrological model such as GR models. `NA` if not used.

`GRiwrm` function helps to rename the columns of the dataframe and assign the variable classes.

```{r griwrm}
seine_nodes$id_aval[seine_nodes$id_aval == ""] <- NA
seine_nodes$distance_aval <- as.double(seine_nodes$distance_aval) / 1000
seine_nodes$model <- "RunModel_GR4J"
# Generate the GRiwrm object
griwrm <- GRiwrm(seine_nodes, list(id = "id_sgl", down = "id_aval", length = "distance_aval"))
griwrm
```

The diagram of the network structure is represented below with in blue the upstream nodes with a GR4J model and in green the intermediate nodes with an SD (GR4J + LAG) model.

```{r DiagramGRiwrm, fig.height = 7, fig.width = 8}
DiagramGRiwrm(griwrm)
```



## Observation time series

Loading hydrometeorological data on the Seine river basin from the ClimAware project:

```{r QNAT, warning=FALSE, message=FALSE}
library(seinebasin)
data(QNAT)
```

## Generate the GRIWRM InputsModel object

The GRIWRM InputsModel object is a list of **airGR** InputsModel. The identifier of the sub-basin is used as key in the list which is ordered from upstream to downstream.

The **airGR** CreateInputsModel function is extended in order to handle the griwrm object which describe the basin diagram:


```{r CreateInputsModel}
InputsModel <- CreateInputsModel(griwrm, DatesR, Precip, PotEvap, Qnat)
```



## Save data for next vignettes

```{r save}
dir.create("_cache", showWarnings = FALSE)
save(griwrm, InputsModel, file = "_cache/V01.RData")
```

