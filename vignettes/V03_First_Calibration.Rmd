---
title: "First calibration of the model"
author: "David Dorchies"
vignette: >
  %\VignetteIndexEntry{Calibration of naturalised semi-distributive model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading libraries, network and time series data

Run `vignette("01_First_network", package = "griwrm")` and `vignette("02_First_run", package = "griwrm")` before this one in order to create the Rdata files loaded below:

```{r}
library(griwrm)
load("_cache/V01.RData")
load("_cache/V02.RData")
```

## InputsCrit object

```{r}
InputsCrit <- CreateInputsCrit(
  InputsModel = InputsModel,
  FUN_CRIT = airGR::ErrorCrit_KGE2,
  RunOptions = RunOptions, Qobs = Qobs
)
str(InputsCrit)
```

## GriwrmCalibOptions object

```{r}
CalibOptions <- CreateCalibOptions(InputsModel)
str(CalibOptions)
```

## Calibration

```{r}
OutputsCalib <- Calibration(InputsModel, RunOptions, InputsCrit, CalibOptions)
```

```{r}
save(OutputsCalib, file = "_cache/V03.RData")
```


## Run model with Michel calibration

```{r}
ParamMichel <- sapply(griwrm$id, function(x) {OutputsCalib[[x]]$Param})

OutputsModels <- RunModel(
  InputsModel = InputsModel,
  RunOptions = RunOptions,
  Param = ParamMichel
)
```

## Save calibration data for next vignettes

```{r}
save(ParamMichel, file = "_cache/V03.RData")
```


## Plot the result for each basin

```{r, fig.height = 5, fig.width = 8}
htmltools::tagList(lapply(
  names(OutputsModels),
  function(x) {
    plot(OutputsModels[[x]], Qobs = Qobs[RunOptions[[x]]$IndPeriod_Run,x] , main = x)
  }
))
```

