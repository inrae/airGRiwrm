---
title: "Severn_05: Modelling ungauged stations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Severn_05: Modelling ungauged stations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: airGRiwrm.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 6,
  fig.asp = 0.68,
  out.width = "70%",
  fig.align = "center"
)
```

```{r setup}
library(airGRiwrm)
```

## Why modelling ungauged station in the semi-distributed model?

This vignette introduces the implementation in airGRiwrm of the model developped by @lobligeoisMieuxConnaitreDistribution2014

2 interests:

- increase spatial resolution of the rain fall to improve streamflow simulation [@lobligeoisWhenDoesHigher2014].
- simulate streamflows in location of interest for management purpose

## Presentation of the study case

Using the study case of the vignette #1 and #2, we considere this time that nodes `54095`, `54001` and 
`54029` are ungauged. We simulate the streamflow at these locations by sharing 
hydrological parameters of the gauged node `54032`.

```{r, echo = FALSE}
mmd <- function(x, ...) {
  # For avoiding crash of R CMD build in console mode
  if(Sys.getenv("RSTUDIO") == "1") {
    DiagrammeR::mermaid(x, ...)
  }
}

mmd("
graph LR
id95[54095]
id01[54001]
id29[54029]

subgraph Shared parameters from node 54032
id01 -->| 45 km| 54032
id95 -->| 42 km| id01
id29 -->| 32 km| 54032
end

54032 -->| 15 km| 54057
54002 -->| 43 km| 54057

classDef UpUng fill:#eef
classDef UpGau fill:#aaf
classDef IntUng fill:#efe
classDef IntGau fill:#afa
classDef DirInj fill:#faa

class id95,id29 UpUng
class 54057,54032 IntGau
class id01 IntUng
class 54002 UpGau
")
```

Hydrological parameters at the ungauged nodes will be the same as the one at the gauged node `54032` except for the unit hydrogram parameter which depend on the area of the sub-basin. @lobligeoisMieuxConnaitreDistribution2014 provides the following conversion formula for this parameter:

$$
x_{4i} = \left( \dfrac{S_i}{S_{BV}} \right) ^ {0.3} X_4
$$
With $X_4$ the unit hydrogram parameter for the entire basin at `54032` which as an area of $S_{BV}$; $S_i$ the area and $x_{4i}$ the parameter for the sub-basin $i$.

## Using ungauged stations in the airGRiwrm model

Ungauged stations are specified by using the model "Ungauged" in the `model` column provided in the `CreateGRiwrm` function:

```{r}
data(Severn)
nodes <- Severn$BasinsInfo[, c("gauge_id", "downstream_id", "distance_downstream", "area")]
nodes$model <- "RunModel_GR4J"
nodes$model[nodes$gauge_id %in% c("54095", "54029", "54001")] <- "Ungauged"
griwrmV05 <- CreateGRiwrm(nodes, list(id = "gauge_id", down = "downstream_id", length = "distance_downstream"))
griwrmV05
```

On the following network scheme, the ungauged nodes are cleared than gauged ones with the same color (blue for upstream nodes and green for intermediate and downstream nodes)

```{r}
plot(griwrmV05)
```


## Generation of the GRiwrmInputsModel object

The formatting of the input data is described in the vignette "V01_Structure_SD_model". The following code chunk resumes this formatting procedure:

```{r}
BasinsObs <- Severn$BasinsObs
DatesR <- BasinsObs[[1]]$DatesR
PrecipTot <- cbind(sapply(BasinsObs, function(x) {x$precipitation}))
PotEvapTot <- cbind(sapply(BasinsObs, function(x) {x$peti}))
Precip <- ConvertMeteoSD(griwrmV05, PrecipTot)
PotEvap <- ConvertMeteoSD(griwrmV05, PotEvapTot)
Qobs <- cbind(sapply(BasinsObs, function(x) {x$discharge_spec}))
```

Then, the `GRiwrmInputsModel` object can be generated taking into account the new `GRiwrm` object:

```{r}
IM_U <- CreateInputsModel(griwrmV05, DatesR, Precip, PotEvap, Qobs)
```

# References
